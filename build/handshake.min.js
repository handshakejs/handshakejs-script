/*! handshake-js.js - 0.0.1 - 2014-05-19 - scottmotte */
!function(a){var b=function(){return this instanceof b?(this.uuid=this.Uuid(),this.script=this.CurrentlyExecutedScript(),this.init(),this):new b};b.prototype.init=function(){this.script?(this.script.className+=" handshake-script",this.script.id="handshake-script-"+this.uuid,this.app_name=this.script.getAttribute("data-app_name"),this.root_url=this.script.getAttribute("data-root_url"),this.request_intro=this.script.getAttribute("data-request_intro")||"This is the easiest signup process.<br/>Just enter your email address.",this.request_button=this.script.getAttribute("data-request_button")||"Create Account",this.confirm_intro=this.script.getAttribute("data-confirm_intro")||"Go ahead and check your email.<br/>Enter the code you received here.",this.confirm_button=this.script.getAttribute("data-confirm_button")||"Login",this.confirm_url=this.script.getAttribute("data-confirm_url")||"/login/request.json",(!this.app_name||this.app_name.length<1)&&console.error("Warning: data-app_name not set on script tag. Set to the app_name you setup."),(!this.root_url||this.root_url.length<1)&&console.error("Warning: data-root_url not set on script tag. Set to the root url where you deployed handshake. Likely, https://somedomain.herokuapp.com."),this.draw(),this.events()):console.error("ERROR: Could not find script tag to initialize on.")},a.Handshake=b}(this),function(a){a.prototype._drawCss=function(){this.css='@charset "utf-8";.handshake-hidden{display:none}';var a=document.createElement("style");return a.type="text/css",a.styleSheet?a.styleSheet.cssText=this.css:a.appendChild(document.createTextNode(this.css)),document.body.appendChild(a)}}(Handshake),function(a){a.prototype.draw=function(){this._drawCss(),this._drawEmailForm(),this._drawEmailIntro(),this._drawEmailField(),this._drawEmailSubmitBtn(),this._drawAuthcodeForm(),this._drawAuthcodeIntro(),this._drawAuthcodeField(),this._drawAuthcodeSubmitBtn()},a.prototype._drawEmailForm=function(){return this.email_form=document.createElement("form"),this.email_form.className="handshake-email-form",this.email_form.id="handshake-email-form-"+this.uuid,this.InsertAfter(this.script,this.email_form)},a.prototype._drawEmailSubmitBtn=function(){return this.email_submit_btn=document.createElement("input"),this.email_submit_btn.className="handshake-email-submit-btn",this.email_submit_btn.id="handshake-email-submit-btn-"+this.uuid,this.email_submit_btn.type="submit",this.email_submit_btn.value=this.request_button,this.email_form.appendChild(this.email_submit_btn)},a.prototype._drawEmailField=function(){return this.email_field=document.createElement("input"),this.email_field.className="handshake-email-field",this.email_field.id="handshake-email-field-id-"+this.uuid,this.email_field.type="email",this.email_field.placeholder="email",this.email_form.appendChild(this.email_field)},a.prototype._drawEmailIntro=function(){return this.email_intro=document.createElement("p"),this.email_intro.className="handshake-email-intro",this.email_intro.id="handshake-email-intro-id-"+this.uuid,this.email_intro.innerHTML=this.request_intro,this.email_form.appendChild(this.email_intro)},a.prototype._drawAuthcodeForm=function(){return this.authcode_form=document.createElement("form"),this.authcode_form.className="handshake-authcode-form handshake-hidden",this.authcode_form.id="handshake-authcode-form-"+this.uuid,this.InsertAfter(this.email_form,this.authcode_form)},a.prototype._drawAuthcodeSubmitBtn=function(){return this.authcode_submit_btn=document.createElement("input"),this.authcode_submit_btn.className="handshake-authcode-submit-btn",this.authcode_submit_btn.id="handshake-authcode-submit-btn-"+this.uuid,this.authcode_submit_btn.type="submit",this.authcode_submit_btn.value=this.confirm_button,this.authcode_form.appendChild(this.authcode_submit_btn)},a.prototype._drawAuthcodeField=function(){return this.authcode_field=document.createElement("input"),this.authcode_field.className="handshake-authcode-field",this.authcode_field.id="handshake-authcode-field-id-"+this.uuid,this.authcode_field.maxLength=4,this.authcode_field.type="text",this.authcode_field.inputmode="numeric",this.authcode_field.pattern="[0-9]*",this.authcode_form.appendChild(this.authcode_field)},a.prototype._drawAuthcodeIntro=function(){return this.authcode_intro=document.createElement("p"),this.authcode_intro.className="handshake-authcode-intro",this.authcode_intro.id="handshake-authcode-intro-id-"+this.uuid,this.authcode_intro.innerHTML=this.confirm_intro,this.authcode_form.appendChild(this.authcode_intro)}}(Handshake),function(a){var b,c="click",d="ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch?!0:!1;d&&(c="touchend"),a.prototype.events=function(){b=this,this._submitEmailForm(),this._submitAuthcodeForm()},a.prototype._submitEmailForm=function(){this.email_form.addEventListener("submit",this.requestLogin,!1)},a.prototype._submitAuthcodeForm=function(){this.authcode_form.addEventListener("submit",this.confirmLogin,!1)},a.prototype._showEmailFormOnly=function(){this.removeClass(this.email_form,"handshake-hidden"),this.addClass(this.authcode_form,"handshake-hidden")},a.prototype._showAuthcodeFormOnly=function(){this.addClass(this.email_form,"handshake-hidden"),this.removeClass(this.authcode_form,"handshake-hidden"),this.authcode_field.focus()},a.prototype.requestLogin=function(a){a&&a.preventDefault();var c={email:b.email_field.value,app_name:b.app_name},d=b.root_url+"/api/v0/login/request.json";b.Post(d,c,function(a){a.success?(b.FireEvent("handshake:request_confirm",b.script,a),b._showAuthcodeFormOnly()):(b._showEmailFormOnly(),alert(a.error.message))})},a.prototype.confirmLogin=function(a){a&&a.preventDefault();var c={authcode:b.authcode_field.value,email:b.email_field.value,app_name:b.app_name},d=b.root_url+"/api/v0/login/confirm.json";b.Post(d,c,function(a){a.success?(b.FireEvent("handshake:login_confirm",b.script,a),b.addClass(b.authcode_form,"handshake-hidden")):(b.removeClass(b.authcode_form,"handshake-hidden"),alert(a.error.message))})}}(Handshake),function(a){a.prototype.Uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b,c;return b=16*Math.random()|0,c="x"===a?b:3&b|8,c.toString(16)})},a.prototype.CurrentlyExecutedScript=function(){var a;if(document){var b=document.getElementsByTagName("script");a=b[b.length-1]}return a},a.prototype.InsertAfter=function(a,b){return a.parentNode.insertBefore(b,a.nextSibling)},a.prototype.hasClass=function(a,b){return new RegExp("(\\s|^)"+b+"(\\s|$)").test(a.className)},a.prototype.addClass=function(a,b){this.hasClass(a,b)||(a.className+=(a.className?" ":"")+b)},a.prototype.removeClass=function(a,b){this.hasClass(a,b)&&(a.className=a.className.replace(new RegExp("(\\s|^)"+b+"(\\s|$)")," ").replace(/^\s+|\s+$/g,""))},a.prototype.FireEvent=function(a,b,c){var d=!0,e=!0,f=document.createEvent("Events");f.initEvent(a,d,e),f.data=c,b.dispatchEvent(f)},a.prototype.Post=function(a,b,c){var d=new XMLHttpRequest;d.open("post",a,!0),d.setRequestHeader("Content-type","application/json"),d.onreadystatechange=function(){4==d.readyState&&(200==d.status?c(JSON.parse(d.responseText)):console.error("You found an ajax error. Please create an issue at http://github.com/scottmotte/handshake."))},d.send(JSON.stringify(b))},a.prototype.FireEvent=function(a,b,c){var d=!0,e=!0,f=document.createEvent("Events");f.initEvent(a,d,e),f.data=c,b.dispatchEvent(f)}}(Handshake);var handshake=Handshake();